name: Register MediaFire Accounts

on:
  workflow_dispatch:  # 手动触发
    inputs:
      email_override:
        description: '临时邮箱列表(可选,逗号分隔)'
        required: false
        type: string
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 00:00 自动执行

jobs:
  register_accounts:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 设置超时时间
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # 缓存 pip 依赖

      # 安装系统依赖(针对 Ubuntu 24.04)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libxi6 \
            libxcursor1 \
            libxcomposite1 \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libgbm1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Chrome installation
        run: |
          google-chrome --version || echo "Chrome not pre-installed"

      - name: Run registration script
        env:
          MEDIAFIRE_REF_LINK: ${{ secrets.MEDIAFIRE_REF_LINK }}
          MEDIAFIRE_PASSWORD: ${{ secrets.MEDIAFIRE_PASSWORD }}
          EMAIL_LIST: ${{ inputs.email_override || secrets.EMAIL_LIST }}
        run: |
          python register.py

      # 保存错误截图(如果有)
      - name: Upload error screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: error_*.png
          retention-days: 7

      # 可选: 发送通知(需配置 SLACK_WEBHOOK)
      # - name: Send notification
      #   if: always()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK }}
      #     payload: |
      #       {
      #         "text": "MediaFire 注册任务完成 - 状态: ${{ job.status }}"
      #       }
